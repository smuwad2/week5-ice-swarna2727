<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body onload="getCategories()">
    <div class="container-fluid">
        <h1 class="text-center mb-4">Supermarket</h1>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <span class="lead text-center">Category</span>
            </div>
            <div class="col-md-9">
                <select class="form-select" onchange="getItems()" id="selectCategory">
                    <option value="0">To select</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>

        <div id="itemsList" class="row my-3 py-3">
            <p class="text-center">No items</p>
        </div>
    </div>
    
    <script>
        // Base URL for the server
        const BASE_URL = 'http://localhost:3000';

        async function getCategories() {
            try {
                // Fetch categories from the server using async/await
                const response = await fetch(`${BASE_URL}/categories`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const categories = await response.json();
                showCategories(categories);
                
            } catch (error) {
                console.error('Error fetching categories:', error);
                // Show error message to user
                document.getElementById('itemsList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Error Loading Categories!</h4>
                            <p>Failed to load categories: ${error.message}</p>
                            <p class="mb-0">Please check if the server is running on port 3010.</p>
                        </div>
                    </div>
                `;
            }
        }

        function showCategories(categories) {
            const selectElement = document.getElementById('selectCategory');
            
            // Clear existing options except the first two (To select, All)
            while (selectElement.children.length > 2) {
                selectElement.removeChild(selectElement.lastChild);
            }
            
            // Add each category as an option
            categories.forEach(category => {
                const option = document.createElement('option');
                // Use the original category name as value (not lowercase)
                option.value = category;
                option.textContent = category;
                selectElement.appendChild(option);
            });
            
            console.log('Categories loaded:', categories);
            console.log('Total options:', selectElement.children.length);
        }

        async function getItems() {
            const selectedCategory = document.getElementById('selectCategory').value;
            
            // If "To select" is chosen, do nothing
            if (selectedCategory === '0') {
                document.getElementById('itemsList').innerHTML = '<p class="text-center">No items</p>';
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('itemsList').innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading items...</p>
                    </div>
                `;
                
                let url;
                if (selectedCategory === 'all') {
                    // Fetch all items
                    url = `${BASE_URL}/items`;
                } else {
                    // Fetch items for specific category - use the category name as is
                    url = `${BASE_URL}/items?category=${selectedCategory}`;
                }
                
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const items = await response.json();
                console.log('Items received:', items);
                showItems(items);
                
            } catch (error) {
                console.error('Error fetching items:', error);
                document.getElementById('itemsList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Error Loading Items!</h4>
                            <p>Failed to load items: ${error.message}</p>
                            <p class="mb-0">Please check if the server is running and the category exists.</p>
                        </div>
                    </div>
                `;
            }
        }

        function showItems(items) {
            const itemsListDiv = document.getElementById('itemsList');
            
            if (!items || items.length === 0) {
                itemsListDiv.innerHTML = '<p class="text-center">No items found for this category.</p>';
                return;
            }
            
            let itemsHTML = '';
            
            items.forEach(item => {
                // Create responsive Bootstrap card for each item
                // lg: 3 columns (col-lg-4), md: 2 columns (col-md-6), sm: 1 column (col-12)
                itemsHTML += `
                    <div class="col-lg-4 col-md-6 col-12 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text">
                                    <strong>Category:</strong> ${item.category}<br>
                                    <strong>Price:</strong> $${item.price.toFixed(2)}<br>
                                    <strong>Quantity:</strong> ${item.quantity}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge ${item.quantity > 5 ? 'bg-success' : item.quantity > 0 ? 'bg-warning' : 'bg-danger'}">
                                        ${item.quantity > 0 ? 'In Stock' : 'Out of Stock'}
                                    </span>
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="addToCart('${item.name}', ${item.price})"
                                            ${item.quantity === 0 ? 'disabled' : ''}>
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            itemsListDiv.innerHTML = itemsHTML;
        }

        // Challenge: Add to Cart functionality
        let cart = [];

        function addToCart(itemName, itemPrice) {
            // Add item to cart array
            const existingItem = cart.find(item => item.name === itemName);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    name: itemName,
                    price: itemPrice,
                    quantity: 1
                });
            }
            
            // Show success message
            showNotification(`${itemName} added to cart!`, 'success');
            
            // Update cart display (if you want to show cart count)
            updateCartDisplay();
        }

        function showNotification(message, type) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 250px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" aria-label="Close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        function updateCartDisplay() {
            // Calculate total items in cart
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // You could add a cart indicator in the header
            console.log(`Cart: ${totalItems} items, Total: $${totalPrice.toFixed(2)}`);
        }

        // Optional: Function to view cart contents
        function viewCart() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            let cartSummary = 'Cart Contents:\n\n';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartSummary += `${item.name} x${item.quantity} - $${itemTotal.toFixed(2)}\n`;
                total += itemTotal;
            });
            
            cartSummary += `\nTotal: $${total.toFixed(2)}`;
            alert(cartSummary);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
</body>
</html>